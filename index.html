<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Bitbucket AI PR Reviewer</title>
        <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
        <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
        <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
        <script src="https://cdn.tailwindcss.com"></script>
        <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    </head>

    <body>
        <div id="root"></div>

        <script type="text/babel">
            const { useState, useEffect } = React;
            const { AlertCircle, RefreshCw, Loader2, CheckCircle, Settings, MessageSquare, History } = lucide;

            function BitbucketPRReviewer() {
                const [config, setConfig] = useState({
                    workspace: '',
                    repoSlug: '',
                    username: '',
                    appPassword: '',
                    aiProvider: 'gemini',
                    apiKey: ''
                });

                const [prs, setPrs] = useState([]);
                const [selectedPR, setSelectedPR] = useState(null);
                const [diffData, setDiffData] = useState([]);
                const [aiSuggestions, setAiSuggestions] = useState([]);
                const [reviewHistory, setReviewHistory] = useState([]);
                const [loading, setLoading] = useState(false);
                const [reviewing, setReviewing] = useState(false);
                const [error, setError] = useState('');
                const [showConfig, setShowConfig] = useState(false);
                const [activeTab, setActiveTab] = useState('diff');
                const [commentDraft, setCommentDraft] = useState({});

                useEffect(() => {
                    loadConfig();
                    loadHistory();
                }, []);

                const loadConfig = () => {
                    const saved = localStorage.getItem('bb_config');
                    if (saved) {
                        const parsed = JSON.parse(saved);
                        setConfig(parsed);
                        if (parsed.workspace && parsed.repoSlug) {
                            fetchPRs(parsed);
                        }
                    } else {
                        setShowConfig(true);
                    }
                };

                const loadHistory = () => {
                    const saved = localStorage.getItem('review_history');
                    if (saved) {
                        setReviewHistory(JSON.parse(saved));
                    }
                };

                const saveConfig = () => {
                    localStorage.setItem('bb_config', JSON.stringify(config));
                    setShowConfig(false);
                    fetchPRs(config);
                };

                const saveToHistory = (pr, suggestions) => {
                    const newHistory = [{
                        id: Date.now(),
                        prId: pr.id,
                        prTitle: pr.title,
                        timestamp: new Date().toISOString(),
                        suggestions: suggestions
                    }, ...reviewHistory].slice(0, 20);

                    setReviewHistory(newHistory);
                    localStorage.setItem('review_history', JSON.stringify(newHistory));
                };

                const fetchPRs = async (cfg = config) => {
                    setLoading(true);
                    setError('');
                    try {
                        const auth = btoa(`${cfg.username}:${cfg.appPassword}`);
                        const response = await fetch(
                            `https://api.bitbucket.org/2.0/repositories/${cfg.workspace}/${cfg.repoSlug}/pullrequests?state=OPEN`,
                            { headers: { Authorization: `Basic ${auth}` } }
                        );

                        if (!response.ok) throw new Error('Failed to fetch PRs. Check credentials.');
                        const data = await response.json();
                        setPrs(data.values || []);
                    } catch (err) {
                        setError(err.message);
                    } finally {
                        setLoading(false);
                    }
                };

                const parseDiff = (diffText) => {
                    const files = [];
                    const chunks = diffText.split('diff --git');

                    chunks.slice(1).forEach(chunk => {
                        const lines = chunk.split('\n');
                        const fileName = lines[0].match(/a\/(.*?) b\//)?.[1] || 'unknown';
                        const changes = [];
                        let oldLine = 0, newLine = 0;

                        lines.forEach(line => {
                            if (line.startsWith('@@')) {
                                const match = line.match(/@@ -(\d+),?\d* \+(\d+),?\d* @@/);
                                if (match) {
                                    oldLine = parseInt(match[1]);
                                    newLine = parseInt(match[2]);
                                }
                            } else if (line.startsWith('-') && !line.startsWith('---')) {
                                changes.push({ type: 'removed', content: line.slice(1), oldLine: oldLine++, newLine: null });
                            } else if (line.startsWith('+') && !line.startsWith('+++')) {
                                changes.push({ type: 'added', content: line.slice(1), oldLine: null, newLine: newLine++ });
                            } else if (line.startsWith(' ')) {
                                changes.push({ type: 'unchanged', content: line.slice(1), oldLine: oldLine++, newLine: newLine++ });
                            }
                        });

                        files.push({ fileName, changes });
                    });

                    return files;
                };

                const selectPR = async (pr) => {
                    setSelectedPR(pr);
                    setAiSuggestions([]);
                    setActiveTab('diff');
                    setLoading(true);

                    try {
                        const auth = btoa(`${config.username}:${config.appPassword}`);
                        const response = await fetch(
                            `https://api.bitbucket.org/2.0/repositories/${config.workspace}/${config.repoSlug}/pullrequests/${pr.id}/diff`,
                            { headers: { Authorization: `Basic ${auth}` } }
                        );
                        const diffText = await response.text();
                        const parsed = parseDiff(diffText);
                        setDiffData(parsed);
                    } catch (err) {
                        setError('Failed to load diff');
                    } finally {
                        setLoading(false);
                    }
                };

                const reviewWithAI = async () => {
                    if (!selectedPR || diffData.length === 0) return;

                    setReviewing(true);
                    setError('');

                    try {
                        const diffSummary = diffData.map(file =>
                            `File: ${file.fileName}\n${file.changes.map(c =>
                                c.type === 'added' ? `+${c.content}` :
                                    c.type === 'removed' ? `-${c.content}` : ` ${c.content}`
                            ).join('\n')}`
                        ).join('\n\n');

                        const prompt = `Review this pull request code changes. For each file, provide specific suggestions with:
1. Line number reference
2. Issue severity (critical/warning/suggestion)
3. Short description
4. Suggested fix

PR: ${selectedPR.title}
Description: ${selectedPR.description || 'No description'}

Changes:
${diffSummary}

Return as JSON array:
[{"file":"filename","line":10,"severity":"warning","issue":"Description","suggestion":"Fix"}]`;

                        let reviewText = '';

                        if (config.aiProvider === 'gemini') {
                            const response = await fetch(
                                `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${config.apiKey}`,
                                {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({
                                        contents: [{ parts: [{ text: prompt }] }]
                                    })
                                }
                            );

                            if (!response.ok) throw new Error('AI API error');
                            const data = await response.json();
                            reviewText = data.candidates[0].content.parts[0].text;
                        } else {
                            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${config.apiKey}`
                                },
                                body: JSON.stringify({
                                    model: 'gpt-4',
                                    messages: [{ role: 'user', content: prompt }]
                                })
                            });

                            if (!response.ok) throw new Error('AI API error');
                            const data = await response.json();
                            reviewText = data.choices[0].message.content;
                        }

                        const jsonMatch = reviewText.match(/\[[\s\S]*\]/);
                        let suggestions = [];

                        if (jsonMatch) {
                            suggestions = JSON.parse(jsonMatch[0]);
                        } else {
                            suggestions = [{
                                file: 'General',
                                line: 0,
                                severity: 'suggestion',
                                issue: 'Review Summary',
                                suggestion: reviewText
                            }];
                        }

                        setAiSuggestions(suggestions);
                        saveToHistory(selectedPR, suggestions);
                        setActiveTab('suggestions');
                    } catch (err) {
                        setError(`Review failed: ${err.message}`);
                    } finally {
                        setReviewing(false);
                    }
                };

                const postComment = async (suggestion) => {
                    try {
                        const auth = btoa(`${config.username}:${config.appPassword}`);
                        const comment = commentDraft[suggestion.line] || suggestion.suggestion;

                        await fetch(
                            `https://api.bitbucket.org/2.0/repositories/${config.workspace}/${config.repoSlug}/pullrequests/${selectedPR.id}/comments`,
                            {
                                method: 'POST',
                                headers: {
                                    'Authorization': `Basic ${auth}`,
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    content: { raw: `ü§ñ AI Review:\n\n${comment}` },
                                    inline: {
                                        path: suggestion.file,
                                        to: suggestion.line
                                    }
                                })
                            }
                        );

                        alert('Comment posted successfully!');
                    } catch (err) {
                        alert('Failed to post comment: ' + err.message);
                    }
                };

                if (showConfig) {
                    return (
                        <div className="min-h-screen bg-gray-900 p-6">
                            <div className="max-w-2xl mx-auto bg-gray-800 rounded-lg shadow-xl p-6">
                                <h1 className="text-2xl font-bold text-white mb-6">‚öôÔ∏è Configuration</h1>

                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-300 mb-1">Bitbucket Workspace</label>
                                        <input
                                            type="text"
                                            value={config.workspace}
                                            onChange={e => setConfig({ ...config, workspace: e.target.value })}
                                            className="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded text-white"
                                            placeholder="my-workspace"
                                        />
                                    </div>

                                    <div>
                                        <label className="block text-sm font-medium text-gray-300 mb-1">Repository Slug</label>
                                        <input
                                            type="text"
                                            value={config.repoSlug}
                                            onChange={e => setConfig({ ...config, repoSlug: e.target.value })}
                                            className="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded text-white"
                                            placeholder="my-repo"
                                        />
                                    </div>

                                    <div>
                                        <label className="block text-sm font-medium text-gray-300 mb-1">Bitbucket Username</label>
                                        <input
                                            type="text"
                                            value={config.username}
                                            onChange={e => setConfig({ ...config, username: e.target.value })}
                                            className="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded text-white"
                                        />
                                    </div>

                                    <div>
                                        <label className="block text-sm font-medium text-gray-300 mb-1">Bitbucket App Password</label>
                                        <input
                                            type="password"
                                            value={config.appPassword}
                                            onChange={e => setConfig({ ...config, appPassword: e.target.value })}
                                            className="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded text-white"
                                        />
                                        <p className="text-xs text-gray-400 mt-1">Create at: Bitbucket Settings ‚Üí App passwords (needs pullrequest:read & write)</p>
                                    </div>

                                    <div>
                                        <label className="block text-sm font-medium text-gray-300 mb-1">AI Provider</label>
                                        <select
                                            value={config.aiProvider}
                                            onChange={e => setConfig({ ...config, aiProvider: e.target.value })}
                                            className="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded text-white"
                                        >
                                            <option value="gemini">Google Gemini Pro (Free)</option>
                                            <option value="openai">OpenAI GPT-4</option>
                                        </select>
                                    </div>

                                    <div>
                                        <label className="block text-sm font-medium text-gray-300 mb-1">AI API Key</label>
                                        <input
                                            type="password"
                                            value={config.apiKey}
                                            onChange={e => setConfig({ ...config, apiKey: e.target.value })}
                                            className="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded text-white"
                                        />
                                        <p className="text-xs text-gray-400 mt-1">
                                            {config.aiProvider === 'gemini' ? 'Get from: ai.google.dev' : 'Get from: platform.openai.com'}
                                        </p>
                                    </div>

                                    <button
                                        onClick={saveConfig}
                                        className="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700 font-medium"
                                    >
                                        üíæ Save Configuration
                                    </button>
                                </div>
                            </div>
                        </div>
                    );
                }

                return (
                    <div className="min-h-screen bg-gray-900 text-white">
                        <div className="border-b border-gray-800 bg-gray-950">
                            <div className="max-w-full mx-auto px-6 py-4 flex justify-between items-center">
                                <div>
                                    <h1 className="text-2xl font-bold">ü§ñ AI PR Reviewer</h1>
                                    <p className="text-sm text-gray-400">{config.workspace}/{config.repoSlug}</p>
                                </div>
                                <div className="flex gap-2">
                                    <button
                                        onClick={() => setActiveTab('history')}
                                        className="flex items-center gap-2 px-4 py-2 bg-gray-800 rounded hover:bg-gray-700"
                                    >
                                        <History className="w-4 h-4" />
                                        History
                                    </button>
                                    <button
                                        onClick={() => setShowConfig(true)}
                                        className="flex items-center gap-2 px-4 py-2 bg-gray-800 rounded hover:bg-gray-700"
                                    >
                                        <Settings className="w-4 h-4" />
                                        Settings
                                    </button>
                                    <button
                                        onClick={() => fetchPRs()}
                                        disabled={loading}
                                        className="flex items-center gap-2 px-4 py-2 bg-blue-600 rounded hover:bg-blue-700 disabled:opacity-50"
                                    >
                                        <RefreshCw className={`w-4 h-4 ${loading ? 'animate-spin' : ''}`} />
                                        Refresh
                                    </button>
                                </div>
                            </div>
                        </div>

                        {error && (
                            <div className="mx-6 mt-4 p-4 bg-red-900/50 border border-red-700 rounded flex items-start gap-2">
                                <AlertCircle className="w-5 h-5 text-red-400 flex-shrink-0 mt-0.5" />
                                <span className="text-red-200">{error}</span>
                            </div>
                        )}

                        <div className="flex h-[calc(100vh-120px)]">
                            <div className="w-80 border-r border-gray-800 bg-gray-950 overflow-y-auto">
                                <div className="p-4">
                                    <h2 className="font-semibold mb-3 text-gray-300">Open Pull Requests ({prs.length})</h2>
                                    {loading ? (
                                        <div className="flex justify-center p-8">
                                            <Loader2 className="w-6 h-6 animate-spin text-blue-500" />
                                        </div>
                                    ) : (
                                        <div className="space-y-2">
                                            {prs.map(pr => (
                                                <div
                                                    key={pr.id}
                                                    onClick={() => selectPR(pr)}
                                                    className={`p-3 rounded cursor-pointer transition ${selectedPR?.id === pr.id ? 'bg-blue-900/50 border border-blue-700' : 'bg-gray-800 hover:bg-gray-700'}`}
                                                >
                                                    <div className="font-medium text-sm mb-1">#{pr.id} {pr.title}</div>
                                                    <div className="text-xs text-gray-400">{pr.author.display_name}</div>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            </div>

                            <div className="flex-1 flex flex-col">
                                {selectedPR ? (
                                    <>
                                        <div className="border-b border-gray-800 bg-gray-950 p-4">
                                            <div className="flex justify-between items-start mb-3">
                                                <div>
                                                    <h2 className="text-xl font-bold">#{selectedPR.id} {selectedPR.title}</h2>
                                                    <p className="text-sm text-gray-400 mt-1">{selectedPR.description || 'No description'}</p>
                                                </div>
                                                <button
                                                    onClick={reviewWithAI}
                                                    disabled={reviewing || diffData.length === 0}
                                                    className="flex items-center gap-2 px-6 py-2 bg-green-600 rounded hover:bg-green-700 disabled:opacity-50 font-medium"
                                                >
                                                    {reviewing ? (
                                                        <>
                                                            <Loader2 className="w-4 h-4 animate-spin" />
                                                            Analyzing...
                                                        </>
                                                    ) : (
                                                        <>
                                                            <CheckCircle className="w-4 h-4" />
                                                            AI Review
                                                        </>
                                                    )}
                                                </button>
                                            </div>

                                            <div className="flex gap-2">
                                                <button
                                                    onClick={() => setActiveTab('diff')}
                                                    className={`px-4 py-2 rounded ${activeTab === 'diff' ? 'bg-gray-700' : 'bg-gray-800 hover:bg-gray-700'}`}
                                                >
                                                    üìù Diff View
                                                </button>
                                                <button
                                                    onClick={() => setActiveTab('suggestions')}
                                                    className={`px-4 py-2 rounded ${activeTab === 'suggestions' ? 'bg-gray-700' : 'bg-gray-800 hover:bg-gray-700'}`}
                                                >
                                                    üí° AI Suggestions ({aiSuggestions.length})
                                                </button>
                                            </div>
                                        </div>

                                        <div className="flex-1 overflow-y-auto p-4">
                                            {activeTab === 'diff' && (
                                                <div className="space-y-6">
                                                    {diffData.map((file, idx) => (
                                                        <div key={idx} className="bg-gray-800 rounded-lg overflow-hidden">
                                                            <div className="bg-gray-900 px-4 py-2 font-mono text-sm border-b border-gray-700">
                                                                {file.fileName}
                                                            </div>
                                                            <div className="font-mono text-xs">
                                                                {file.changes.map((change, i) => (
                                                                    <div
                                                                        key={i}
                                                                        className={`flex ${change.type === 'added' ? 'bg-green-900/30' :
                                                                            change.type === 'removed' ? 'bg-red-900/30' : ''}`}
                                                                    >
                                                                        <span className="px-3 py-1 text-gray-500 select-none w-12 text-right">{change.oldLine || ''}</span>
                                                                        <span className="px-3 py-1 text-gray-500 select-none w-12 text-right">{change.newLine || ''}</span>
                                                                        <span className={`px-3 py-1 flex-1 ${change.type === 'added' ? 'text-green-300' :
                                                                            change.type === 'removed' ? 'text-red-300' : 'text-gray-300'}`}>
                                                                            {change.type === 'added' ? '+' : change.type === 'removed' ? '-' : ' '}
                                                                            {change.content}
                                                                        </span>
                                                                    </div>
                                                                ))}
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            )}

                                            {activeTab === 'suggestions' && (
                                                <div className="space-y-4">
                                                    {aiSuggestions.length === 0 ? (
                                                        <div className="text-center p-12 text-gray-500">
                                                            Click "AI Review" to get suggestions
                                                        </div>
                                                    ) : (
                                                        aiSuggestions.map((sug, idx) => (
                                                            <div key={idx} className={`bg-gray-800 rounded-lg p-4 border-l-4 ${sug.severity === 'critical' ? 'border-red-500' :
                                                                sug.severity === 'warning' ? 'border-yellow-500' : 'border-blue-500'}`}>
                                                                <div className="flex justify-between items-start mb-2">
                                                                    <div>
                                                                        <span className={`text-xs font-bold px-2 py-1 rounded ${sug.severity === 'critical' ? 'bg-red-900 text-red-200' :
                                                                            sug.severity === 'warning' ? 'bg-yellow-900 text-yellow-200' : 'bg-blue-900 text-blue-200'}`}>
                                                                            {sug.severity.toUpperCase()}
                                                                        </span>
                                                                        <span className="ml-2 text-sm text-gray-400">{sug.file}:{sug.line}</span>
                                                                    </div>
                                                                    <button
                                                                        onClick={() => postComment(sug)}
                                                                        className="flex items-center gap-1 px-3 py-1 bg-blue-600 rounded text-sm hover:bg-blue-700"
                                                                    >
                                                                        <MessageSquare className="w-3 h-3" />
                                                                        Post Comment
                                                                    </button>
                                                                </div>
                                                                <div className="text-sm mb-2">
                                                                    <strong className="text-yellow-300">Issue:</strong> {sug.issue}
                                                                </div>
                                                                <div className="text-sm mb-3">
                                                                    <strong className="text-green-300">Suggestion:</strong> {sug.suggestion}
                                                                </div>
                                                                <textarea
                                                                    value={commentDraft[sug.line] || sug.suggestion}
                                                                    onChange={(e) => setCommentDraft({ ...commentDraft, [sug.line]: e.target.value })}
                                                                    className="w-full p-2 bg-gray-900 border border-gray-700 rounded text-sm"
                                                                    rows="2"
                                                                    placeholder="Edit before posting..."
                                                                />
                                                            </div>
                                                        ))
                                                    )}
                                                </div>
                                            )}

                                            {activeTab === 'history' && (
                                                <div className="space-y-4">
                                                    {reviewHistory.length === 0 ? (
                                                        <div className="text-center p-12 text-gray-500">
                                                            No review history yet
                                                        </div>
                                                    ) : (
                                                        reviewHistory.map((item) => (
                                                            <div key={item.id} className="bg-gray-800 rounded-lg p-4">
                                                                <div className="flex justify-between items-start mb-2">
                                                                    <div>
                                                                        <h3 className="font-semibold">PR #{item.prId}: {item.prTitle}</h3>
                                                                        <p className="text-xs text-gray-400">{new Date(item.timestamp).toLocaleString()}</p>
                                                                    </div>
                                                                </div>
                                                                <div className="text-sm text-gray-400">
                                                                    {item.suggestions.length} suggestions found
                                                                </div>
                                                            </div>
                                                        ))
                                                    )}
                                                </div>
                                            )}
                                        </div>
                                    </>
                                ) : (
                                    <div className="flex-1 flex items-center justify-center text-gray-500">
                                        <div className="text-center">
                                            <History className="w-16 h-16 mx-auto mb-4 opacity-50" />
                                            <p className="text-lg">Select a PR to start reviewing</p>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                );
            }

            ReactDOM.createRoot(document.getElementById('root')).render(<BitbucketPRReviewer />);
        </script>
    </body>

</html>
